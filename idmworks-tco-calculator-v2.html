<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IDMWorks - IGA Total Cost of Ownership Calculator</title>
    <style>
        :root {
            --idm-navy: #241F55;
            --idm-gray: #6C6A6F;
            --idm-cyan: #00C2EF;
            --idm-blue: #0661AB;
            --idm-purple: #A72DBE;
            --idm-magenta: #91257A;
            --idm-red: #EC313A;
            --idm-orange: #EF3D2F;
            --idm-yellow: #FFC91E;
            --primary-color: #241F55;
            --secondary-color: #A72DBE;
            --accent-color: #00C2EF;
            --text-color: #444444;
            --bg-color: #f9f9f9;
            --border-radius: 12px;
            --box-shadow: 0 4px 12px rgba(36, 31, 85, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: white;
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
            border-radius: var(--border-radius);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 30px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            max-width: 200px;
            height: auto;
        }

        h1 {
            color: var(--primary-color);
            font-size: 1.8rem;
            font-weight: 600;
        }

        /* Mode Toggle */
        .mode-toggle {
            display: flex;
            gap: 0.5rem;
            background: var(--bg-color);
            padding: 0.5rem;
            border-radius: 8px;
        }

        .mode-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            color: var(--text-color);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .mode-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .mode-btn:hover:not(.active) {
            background: white;
        }

        /* Card */
        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 30px;
            margin-bottom: 30px;
        }

        /* Welcome Screen */
        #welcome-screen {
            text-align: center;
        }

        .welcome-header {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: var(--primary-color);
            font-weight: 700;
        }

        .welcome-subheader {
            font-size: 1.5rem;
            margin-bottom: 30px;
            color: var(--secondary-color);
            font-style: italic;
        }

        .info-section {
            text-align: left;
            margin-bottom: 30px;
            padding: 25px;
            background: #f5f5f5;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--accent-color);
        }

        .info-section h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .formula {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            border-left: 3px solid var(--secondary-color);
        }

        .start-button {
            background: linear-gradient(135deg, var(--secondary-color), var(--accent-color));
            color: white;
            font-size: 1.2rem;
            padding: 15px 50px;
            border-radius: var(--border-radius);
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .start-button:hover {
            transform: translateY(-3px);
            box-shadow: var(--box-shadow);
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            height: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary-color), var(--accent-color));
            width: 0;
            transition: width 0.3s ease;
        }

        /* Use Case Selection */
        .use-cases-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .use-case-card {
            background: white;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .use-case-card:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: var(--box-shadow);
        }

        .use-case-card.selected {
            background: linear-gradient(135deg, rgba(167, 45, 190, 0.1), rgba(0, 194, 239, 0.1));
            border-color: var(--secondary-color);
            border-width: 3px;
        }

        .use-case-card.selected::before {
            content: "‚úì";
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--secondary-color);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .use-case-title {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .use-case-category {
            font-size: 0.85rem;
            color: var(--idm-gray);
            margin-top: 5px;
        }

        .selected-count {
            text-align: center;
            font-size: 1.1rem;
            color: var(--secondary-color);
            margin-bottom: 20px;
            font-weight: 500;
        }

        /* Questions */
        .question-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--secondary-color);
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 10px;
        }

        .input-group {
            margin-bottom: 25px;
        }

        .input-label {
            display: block;
            font-weight: 500;
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .input-field {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        /* Hide number spinners */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        input[type="number"] {
            -moz-appearance: textfield;
        }

        /* Buttons */
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary-color), var(--accent-color));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--box-shadow);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--idm-gray);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--primary-color);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline:hover {
            background: var(--primary-color);
            color: white;
        }

        .btn-danger {
            background: var(--idm-red);
            color: white;
        }

        .btn-danger:hover {
            background: #c71f1f;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: space-between;
            margin-top: 30px;
        }

        /* Processing Screen */
        #processing-screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .processing-text {
            margin-top: 20px;
            font-size: 1.2rem;
            color: var(--primary-color);
        }

        /* Results */
        .results-summary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 40px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            text-align: center;
        }

        .results-title {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .results-value {
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 30px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .result-item {
            background: rgba(255,255,255,0.15);
            padding: 20px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .result-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .result-value {
            font-size: 1.8rem;
            font-weight: 600;
        }

        /* Config Panel Styles */
        .use-case-section {
            background: var(--bg-color);
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
        }

        .use-case-section-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ddd;
        }

        .use-case-section-info {
            flex: 1;
        }

        .use-case-section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .use-case-section-meta {
            font-size: 0.85rem;
            color: var(--idm-gray);
            margin-bottom: 10px;
        }

        .use-case-formula {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            background: white;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        .use-case-section-actions {
            display: flex;
            gap: 10px;
        }

        .nested-questions {
            margin-top: 15px;
        }

        .nested-question-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .nested-question-content {
            flex: 1;
            margin-right: 15px;
        }

        .nested-question-text {
            font-size: 1rem;
            color: var(--text-color);
            margin-bottom: 5px;
        }

        .nested-question-meta {
            font-size: 0.85rem;
            color: var(--idm-gray);
        }

        .nested-question-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .add-question-prompt {
            text-align: center;
            padding: 30px;
            background: white;
            border: 2px dashed #ddd;
            border-radius: 8px;
            color: var(--idm-gray);
            margin-top: 15px;
        }

        .list-item {
            background: var(--bg-color);
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .list-item-content {
            flex: 1;
        }

        .list-item-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .list-item-meta {
            font-size: 0.85rem;
            color: var(--idm-gray);
        }

        .list-item-actions {
            display: flex;
            gap: 10px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 25px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 500;
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        small {
            display: block;
            margin-top: 5px;
            color: var(--idm-gray);
            font-size: 0.85rem;
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--idm-gray);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .empty-state-text {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        /* Utility */
        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 20px;
            }

            .mode-toggle {
                width: 100%;
            }

            .mode-btn {
                flex: 1;
            }

            .use-cases-grid {
                grid-template-columns: 1fr;
            }

            .btn-group {
                flex-direction: column;
            }

            .results-value {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div class="header-content">
                <div class="logo-section">
                    <img src="" alt="IDMWorks" class="logo" id="logo-img" style="display: none;">
                    <h1>IGA Total Cost of Ownership Calculator</h1>
                </div>
                <div class="mode-toggle">
                    <button class="mode-btn active" onclick="switchMode('calculate')">Calculate TCO</button>
                    <button class="mode-btn" onclick="switchMode('configure')">Configure</button>
                </div>
            </div>
        </header>

        <!-- Calculate Panel -->
        <div id="calculatePanel">
            <!-- Welcome Screen -->
            <div id="welcome-screen" class="card">
                <h2 class="welcome-header">Welcome to the IGA TCO Calculator</h2>
                <p class="welcome-subheader">Discover Your True Identity Governance Costs</p>

                <div class="info-section">
                    <h3>What This Calculator Does</h3>
                    <p>This tool helps you quantify the <strong>total cost of ownership</strong> for your Identity Governance and Administration (IGA) program. Many organizations focus solely on software licensing costs, but the real expense lies in the <strong>people, processes, and time</strong> required to manage identities, access, and compliance.</p>
                    
                    <p style="margin-top: 15px;">By answering a series of questions about your current processes, you'll get a comprehensive view of:</p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>Monthly operational costs</li>
                        <li>Annual TCO including license fees</li>
                        <li>3-year and 5-year investment projections</li>
                    </ul>
                </div>

                <div class="info-section">
                    <h3>How It Works</h3>
                    <p><strong>Step 1:</strong> Select the identity governance use cases that apply to your organization</p>
                    <p><strong>Step 2:</strong> Answer questions about volumes, staff involvement, and time spent</p>
                    <p><strong>Step 3:</strong> Review your total cost of ownership breakdown</p>
                    
                    <div class="formula">
                        <div class="formula-label">Standard Cost Formula:</div>
                        Monthly Cost = Volume √ó Staff Count √ó Hourly Rate √ó Hours per Transaction
                    </div>
                </div>

                <button class="start-button" onclick="startCalculator()">Start Assessment ‚Üí</button>
            </div>

            <!-- Calculator Steps -->
            <div id="calculator-container" class="hidden">
                <div class="progress-container">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>

                <!-- Step 1: Use Case Selection -->
                <div id="step-1" class="card">
                    <h2 class="section-title">Step 1: Select Your Use Cases</h2>
                    <p style="margin-bottom: 25px; color: var(--idm-gray);">
                        Choose the identity governance processes that are relevant to your organization. You can select as many as apply.
                    </p>
                    <div class="selected-count" id="selected-count">0 use cases selected</div>
                    <div class="use-cases-grid" id="use-cases-grid">
                        <!-- Use cases populated here -->
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="backToWelcome()">‚Üê Back</button>
                        <button class="btn btn-primary" id="next-btn-step1" onclick="goToStep2()" disabled>Next: Answer Questions ‚Üí</button>
                    </div>
                </div>

                <!-- Step 2: Questions -->
                <div id="step-2" class="card hidden">
                    <h2 class="section-title">Step 2: Answer Questions</h2>
                    <p style="margin-bottom: 25px; color: var(--idm-gray);">
                        Provide information about each selected use case. Enter your best estimates - you can always edit these later.
                    </p>
                    <div id="questions-container">
                        <!-- Questions populated here -->
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="backToStep1()">‚Üê Back</button>
                        <button class="btn btn-primary" id="calculate-btn" onclick="calculateTCO()">Calculate TCO ‚Üí</button>
                    </div>
                </div>
            </div>

            <!-- Processing Screen -->
            <div id="processing-screen" class="card">
                <div class="spinner"></div>
                <p class="processing-text">Calculating your Total Cost of Ownership...</p>
            </div>

            <!-- Results Screen -->
            <div id="results-screen" class="hidden">
                <div class="results-summary">
                    <div class="results-title">Monthly Total Cost of Ownership</div>
                    <div class="results-value" id="monthly-total">$0</div>
                    <div class="results-grid">
                        <div class="result-item">
                            <div class="result-label">Annual TCO</div>
                            <div class="result-value" id="annual-total">$0</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">3-Year TCO</div>
                            <div class="result-value" id="three-year-total">$0</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">5-Year TCO</div>
                            <div class="result-value" id="five-year-total">$0</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="section-title">Cost Breakdown by Use Case</h2>
                    <div id="breakdown-container">
                        <!-- Breakdown populated here -->
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="exportResults()">Export Report</button>
                    <button class="btn btn-secondary" onclick="editResponses()">‚Üê Edit Responses</button>
                    <button class="btn btn-outline" onclick="startOver()">Start Over</button>
                </div>
            </div>
        </div>

        <!-- Configure Panel -->
        <div id="configurePanel" class="hidden">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="section-title" style="margin: 0; border: none; padding: 0;">Manage Use Cases & Questions</h2>
                    <button class="btn btn-primary" onclick="showAddUseCaseForm()">+ Add Use Case</button>
                </div>
                <p style="margin-bottom: 25px; color: var(--idm-gray);">
                    Configure use cases, add questions, and define cost formulas. Changes are saved automatically.
                </p>
                <div id="use-case-management">
                    <!-- Use case sections populated here -->
                </div>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="section-title" style="margin: 0; border: none; padding: 0;">Questions Library</h2>
                    <button class="btn btn-primary" onclick="showAddQuestionForm()">+ Add Question</button>
                </div>
                <p style="margin-bottom: 25px; color: var(--idm-gray);">
                    Create reusable questions that can be assigned to multiple use cases.
                </p>
                <div id="question-library">
                    <!-- Questions populated here -->
                </div>
            </div>

            <div class="card">
                <h2 class="section-title">Import / Export Configuration</h2>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="exportConfiguration()">Export Configuration (JSON)</button>
                    <button class="btn btn-outline" onclick="document.getElementById('import-file').click()">Import Configuration</button>
                    <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importConfiguration(event)">
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        // Configuration Data
        let config = {
            useCases: [],
            questions: [],
            mappings: []
        };

        // User Data
        let selectedUseCases = new Set();
        let userResponses = {};
        let annualLicenseCost = 0;

        // Initialize
        function init() {
            loadConfigFromStorage();
            if (config.useCases.length === 0) {
                initializeSampleData();
            }
        }

        // Sample Data
        function initializeSampleData() {
            config.useCases = [
                { id: 1, name: "Onboarding a new user", category: "Joiner/Mover/Leaver", formula: "numUsers * staffCount * laborRate * hours" },
                { id: 2, name: "Offboarding an employee", category: "Joiner/Mover/Leaver", formula: "numUsers * staffCount * laborRate * hours" },
                { id: 3, name: "Duplicate User Creation", category: "Data Quality", formula: "numDuplicates * staffCount * laborRate * hours" },
                { id: 4, name: "Access request processing delays", category: "Access Management", formula: "delayHours * numUsers * laborRate" },
                { id: 5, name: "GRC - Manual Campaigns", category: "Governance", formula: "numCampaigns * reviewers * laborRate * hoursPerReview" },
                { id: 6, name: "Service Desk - Password resets", category: "Operations", formula: "numResets * laborRate * timePerReset" }
            ];

            config.questions = [
                { id: 1, text: "How many employees, contractors, and/or suppliers are onboarded per month?", inputType: "number", defaultValue: 0 },
                { id: 2, text: "How many people on the Security team are involved when a new user is onboarded?", inputType: "number", defaultValue: 0 },
                { id: 3, text: "What is the average fully burdened hourly labor rate for each Security team member?", inputType: "number", defaultValue: 60 },
                { id: 4, text: "How many hours (on average) does each Security team member spend onboarding a User?", inputType: "number", defaultValue: 0 },
                { id: 5, text: "How many employees, contractors, and/or suppliers are off-boarded per month?", inputType: "number", defaultValue: 0 },
                { id: 6, text: "How many people are involved when a user is off-boarded?", inputType: "number", defaultValue: 0 },
                { id: 7, text: "What is the average fully burdened hourly labor rate for staff involved in offboarding?", inputType: "number", defaultValue: 50 },
                { id: 8, text: "How many hours does it take to off-board a user?", inputType: "number", defaultValue: 0 },
                { id: 9, text: "How many duplicate user accounts are researched and removed per month?", inputType: "number", defaultValue: 0 },
                { id: 10, text: "How many staff members are involved in researching and removing duplicates?", inputType: "number", defaultValue: 0 },
                { id: 11, text: "What is the average hourly labor rate for duplicate resolution staff?", inputType: "number", defaultValue: 50 },
                { id: 12, text: "How many hours does it take to research and remove a duplicate account?", inputType: "number", defaultValue: 0 },
                { id: 13, text: "What is the average amount of time (hours) a new user cannot perform their job due to access delays?", inputType: "number", defaultValue: 0 },
                { id: 14, text: "How many new users per month experience access delays?", inputType: "number", defaultValue: 0 },
                { id: 15, text: "What is the average fully burdened hourly labor rate per employee?", inputType: "number", defaultValue: 50 },
                { id: 16, text: "How many manual access certification campaigns are conducted per month?", inputType: "number", defaultValue: 0 },
                { id: 17, text: "How many reviewers participate in each campaign?", inputType: "number", defaultValue: 0 },
                { id: 18, text: "What is the average hourly labor rate for reviewers?", inputType: "number", defaultValue: 75 },
                { id: 19, text: "How many hours does each reviewer spend per campaign?", inputType: "number", defaultValue: 0 },
                { id: 20, text: "How many password resets are processed per month?", inputType: "number", defaultValue: 0 },
                { id: 21, text: "What is the service desk hourly labor rate?", inputType: "number", defaultValue: 40 },
                { id: 22, text: "How many minutes does each password reset take?", inputType: "number", defaultValue: 0 }
            ];

            config.mappings = [
                { useCaseId: 1, questionId: 1, variableName: "numUsers" },
                { useCaseId: 1, questionId: 2, variableName: "staffCount" },
                { useCaseId: 1, questionId: 3, variableName: "laborRate" },
                { useCaseId: 1, questionId: 4, variableName: "hours" },
                { useCaseId: 2, questionId: 5, variableName: "numUsers" },
                { useCaseId: 2, questionId: 6, variableName: "staffCount" },
                { useCaseId: 2, questionId: 7, variableName: "laborRate" },
                { useCaseId: 2, questionId: 8, variableName: "hours" },
                { useCaseId: 3, questionId: 9, variableName: "numDuplicates" },
                { useCaseId: 3, questionId: 10, variableName: "staffCount" },
                { useCaseId: 3, questionId: 11, variableName: "laborRate" },
                { useCaseId: 3, questionId: 12, variableName: "hours" },
                { useCaseId: 4, questionId: 13, variableName: "delayHours" },
                { useCaseId: 4, questionId: 14, variableName: "numUsers" },
                { useCaseId: 4, questionId: 15, variableName: "laborRate" },
                { useCaseId: 5, questionId: 16, variableName: "numCampaigns" },
                { useCaseId: 5, questionId: 17, variableName: "reviewers" },
                { useCaseId: 5, questionId: 18, variableName: "laborRate" },
                { useCaseId: 5, questionId: 19, variableName: "hoursPerReview" },
                { useCaseId: 6, questionId: 20, variableName: "numResets" },
                { useCaseId: 6, questionId: 21, variableName: "laborRate" },
                { useCaseId: 6, questionId: 22, variableName: "timePerReset" }
            ];

            saveConfigToStorage();
        }

        // Storage Functions
        function saveConfigToStorage() {
            localStorage.setItem('idmworks-tco-config', JSON.stringify(config));
        }

        function loadConfigFromStorage() {
            const stored = localStorage.getItem('idmworks-tco-config');
            if (stored) {
                config = JSON.parse(stored);
            }
        }

        // Mode Switching
        function switchMode(mode) {
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            
            if (mode === 'calculate') {
                document.querySelector('.mode-btn:first-child').classList.add('active');
                document.getElementById('calculatePanel').classList.remove('hidden');
                document.getElementById('configurePanel').classList.add('hidden');
            } else {
                document.querySelector('.mode-btn:last-child').classList.add('active');
                document.getElementById('calculatePanel').classList.add('hidden');
                document.getElementById('configurePanel').classList.remove('hidden');
                renderConfigPanel();
            }
        }

        // Calculate Flow
        function startCalculator() {
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('calculator-container').classList.remove('hidden');
            renderUseCases();
            updateProgressBar(50);
        }

        function backToWelcome() {
            document.getElementById('calculator-container').classList.add('hidden');
            document.getElementById('welcome-screen').classList.remove('hidden');
            selectedUseCases.clear();
            updateProgressBar(0);
        }

        function renderUseCases() {
            const grid = document.getElementById('use-cases-grid');
            grid.innerHTML = '';

            config.useCases.forEach(useCase => {
                const card = document.createElement('div');
                card.className = `use-case-card ${selectedUseCases.has(useCase.id) ? 'selected' : ''}`;
                card.onclick = () => toggleUseCase(useCase.id);
                card.innerHTML = `
                    <div class="use-case-title">${useCase.name}</div>
                    <div class="use-case-category">${useCase.category}</div>
                `;
                grid.appendChild(card);
            });

            updateSelectedCount();
        }

        function toggleUseCase(id) {
            if (selectedUseCases.has(id)) {
                selectedUseCases.delete(id);
            } else {
                selectedUseCases.add(id);
            }
            renderUseCases();
        }

        function updateSelectedCount() {
            const count = selectedUseCases.size;
            document.getElementById('selected-count').textContent = `${count} use case${count !== 1 ? 's' : ''} selected`;
            document.getElementById('next-btn-step1').disabled = count === 0;
        }

        function goToStep2() {
            document.getElementById('step-1').classList.add('hidden');
            document.getElementById('step-2').classList.remove('hidden');
            renderQuestions();
            updateProgressBar(100);
        }

        function backToStep1() {
            document.getElementById('step-2').classList.add('hidden');
            document.getElementById('step-1').classList.remove('hidden');
            updateProgressBar(50);
        }

        function renderQuestions() {
            const container = document.getElementById('questions-container');
            container.innerHTML = '';

            selectedUseCases.forEach(useCaseId => {
                const useCase = config.useCases.find(uc => uc.id === useCaseId);
                const mappings = config.mappings.filter(m => m.useCaseId === useCaseId);

                const section = document.createElement('div');
                section.className = 'question-section';
                section.innerHTML = `<h3 class="section-title">${useCase.name}</h3>`;

                mappings.forEach(mapping => {
                    const question = config.questions.find(q => q.id === mapping.questionId);
                    if (question) {
                        const group = document.createElement('div');
                        group.className = 'input-group';

                        const savedValue = userResponses[`${useCaseId}-${question.id}`];
                        const displayValue = savedValue !== undefined ? savedValue : '';

                        group.innerHTML = `
                            <label class="input-label">${question.text}</label>
                            <input 
                                type="${question.inputType}" 
                                class="input-field"
                                value="${displayValue}"
                                placeholder="${question.defaultValue}"
                                onchange="saveResponse(${useCaseId}, ${question.id}, this.value)"
                            >
                        `;
                        section.appendChild(group);
                    }
                });

                container.appendChild(section);
            });

            // Add annual license cost
            const licenseSection = document.createElement('div');
            licenseSection.className = 'question-section';
            licenseSection.style.background = '#f5f5f5';
            licenseSection.style.borderLeft = '4px solid var(--secondary-color)';
            licenseSection.innerHTML = `
                <h3 class="section-title">Annual IGA License Cost</h3>
                <div class="input-group">
                    <label class="input-label">What is your current annual license cost for your IGA tool? (Optional)</label>
                    <input 
                        type="number" 
                        class="input-field"
                        value="${annualLicenseCost || ''}"
                        placeholder="$ (Optional)"
                        onchange="annualLicenseCost = parseFloat(this.value) || 0"
                    >
                    <small>Enter your current IGA tool's annual license fee (leave blank if not applicable)</small>
                </div>
            `;
            container.appendChild(licenseSection);
        }

        function saveResponse(useCaseId, questionId, value) {
            const numValue = parseFloat(value);
            userResponses[`${useCaseId}-${questionId}`] = isNaN(numValue) ? 0 : numValue;
        }

        function calculateTCO() {
            document.getElementById('step-2').classList.add('hidden');
            document.getElementById('processing-screen').style.display = 'flex';

            setTimeout(() => {
                let monthlyTotal = 0;
                const breakdown = [];

                selectedUseCases.forEach(useCaseId => {
                    const useCase = config.useCases.find(uc => uc.id === useCaseId);
                    const mappings = config.mappings.filter(m => m.useCaseId === useCaseId);

                    const variables = {};
                    mappings.forEach(mapping => {
                        const value = userResponses[`${useCaseId}-${mapping.questionId}`] || 0;
                        variables[mapping.variableName] = value;
                    });

                    // Convert minutes to hours if needed
                    if (variables.timePerReset !== undefined) {
                        variables.timePerReset = variables.timePerReset / 60;
                    }

                    try {
                        let formulaWithValues = useCase.formula;
                        const sortedVarNames = Object.keys(variables).sort((a, b) => b.length - a.length);
                        
                        sortedVarNames.forEach(varName => {
                            const regex = new RegExp('\\b' + varName + '\\b', 'g');
                            formulaWithValues = formulaWithValues.replace(regex, variables[varName]);
                        });

                        const cost = eval(formulaWithValues) || 0;
                        monthlyTotal += cost;
                        breakdown.push({ name: useCase.name, cost: cost });
                    } catch (e) {
                        console.error('Error calculating', useCase.name, e);
                    }
                });

                displayResults(monthlyTotal, breakdown);
                
                document.getElementById('processing-screen').style.display = 'none';
                document.getElementById('results-screen').classList.remove('hidden');
            }, 1500);
        }

        function displayResults(monthlyTotal, breakdown) {
            const annualTotal = (monthlyTotal * 12) + annualLicenseCost;
            const threeYearTotal = annualTotal * 3;
            const fiveYearTotal = annualTotal * 5;

            document.getElementById('monthly-total').textContent = formatCurrency(monthlyTotal);
            document.getElementById('annual-total').textContent = formatCurrency(annualTotal);
            document.getElementById('three-year-total').textContent = formatCurrency(threeYearTotal);
            document.getElementById('five-year-total').textContent = formatCurrency(fiveYearTotal);

            const container = document.getElementById('breakdown-container');
            container.innerHTML = '';

            breakdown.forEach(item => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <div class="list-item-content">
                        <div class="list-item-title">${item.name}</div>
                    </div>
                    <div style="font-size: 1.3rem; font-weight: 600; color: var(--primary-color);">
                        ${formatCurrency(item.cost)}/month
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        function updateProgressBar(percent) {
            document.getElementById('progress-bar').style.width = percent + '%';
        }

        function editResponses() {
            document.getElementById('results-screen').classList.add('hidden');
            document.getElementById('step-2').classList.remove('hidden');
            updateProgressBar(100);
        }

        function startOver() {
            selectedUseCases.clear();
            userResponses = {};
            annualLicenseCost = 0;
            document.getElementById('results-screen').classList.add('hidden');
            document.getElementById('calculator-container').classList.add('hidden');
            document.getElementById('welcome-screen').classList.remove('hidden');
            updateProgressBar(0);
        }

        function exportResults() {
            const monthlyTotal = document.getElementById('monthly-total').textContent;
            const annualTotal = document.getElementById('annual-total').textContent;
            const threeYearTotal = document.getElementById('three-year-total').textContent;
            const fiveYearTotal = document.getElementById('five-year-total').textContent;

            const breakdownContainer = document.getElementById('breakdown-container');
            const breakdownItems = breakdownContainer.querySelectorAll('.list-item');

            let breakdownHTML = '';
            breakdownItems.forEach((item, index) => {
                const name = item.querySelector('.list-item-title').textContent;
                // Get the second direct child div which contains the cost
                const costDiv = item.children[1];
                const cost = costDiv ? costDiv.textContent : '';
                breakdownHTML += `
                    <tr>
                        <td style="padding: 12px; border-bottom: 1px solid #e7e5e4;">${index + 1}. ${name}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e7e5e4; text-align: right; font-weight: 600; color: #241F55;">${cost}</td>
                    </tr>
                `;
            });

            const reportHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>IDMWorks TCO Assessment Report</title>
    <style>
        @media print { body { margin: 0; } .no-print { display: none; } }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #444; max-width: 800px; margin: 0 auto; padding: 40px 20px; }
        .header { background: linear-gradient(135deg, #241F55 0%, #A72DBE 100%); color: white; padding: 40px; margin: -40px -20px 40px -20px; text-align: center; }
        .header h1 { margin: 0 0 10px 0; font-size: 32px; font-weight: 700; }
        .header p { margin: 0; font-size: 14px; opacity: 0.9; text-transform: uppercase; letter-spacing: 2px; }
        .summary { background: #f5f5f4; border-left: 4px solid #241F55; padding: 30px; margin: 30px 0; }
        .summary h2 { margin: 0 0 20px 0; color: #241F55; font-size: 24px; }
        .summary-item { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #d6d3d1; }
        .summary-label { font-weight: 500; color: #6C6A6F; }
        .summary-value { font-size: 24px; font-weight: 700; color: #241F55; }
        table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        th { background: #241F55; color: white; padding: 15px; text-align: left; font-weight: 600; text-transform: uppercase; font-size: 12px; }
        .footer { margin-top: 60px; padding-top: 20px; border-top: 2px solid #e7e5e4; text-align: center; color: #78716c; font-size: 14px; }
        .print-button { background: #241F55; color: white; border: none; padding: 12px 30px; font-size: 16px; border-radius: 6px; cursor: pointer; margin: 20px 0; }
        .print-button:hover { background: #A72DBE; }
    </style>
</head>
<body>
    <div class="header">
        <h1>IGA Total Cost of Ownership Assessment</h1>
        <p>IDMWorks Advisory Report</p>
    </div>
    <button class="print-button no-print" onclick="window.print()">Print / Save as PDF</button>
    <div class="summary">
        <h2>Cost Summary</h2>
        <div class="summary-item"><span class="summary-label">Monthly Total Cost of Ownership:</span><span class="summary-value">${monthlyTotal}</span></div>
        <div class="summary-item"><span class="summary-label">Annual TCO:</span><span class="summary-value">${annualTotal}</span></div>
        <div class="summary-item"><span class="summary-label">3-Year TCO Investment:</span><span class="summary-value">${threeYearTotal}</span></div>
        <div class="summary-item"><span class="summary-label">5-Year TCO Investment:</span><span class="summary-value">${fiveYearTotal}</span></div>
    </div>
    <div style="margin: 40px 0;"><h2 style="color: #241F55; font-size: 24px; margin-bottom: 20px;">Cost Breakdown by Use Case</h2>
        <table><thead><tr><th>Use Case</th><th style="text-align: right;">Monthly Cost</th></tr></thead><tbody>${breakdownHTML}</tbody></table>
    </div>
    <div class="footer"><p>Generated by IDMWorks TCO Calculator on ${new Date().toLocaleDateString()}</p></div>
</body>
</html>
            `;

            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(reportHTML);
            reportWindow.document.close();
        }

        // Configure Panel Functions
        function renderConfigPanel() {
            renderUseCaseManagement();
            renderQuestionLibrary();
        }

        function renderUseCaseManagement() {
            const container = document.getElementById('use-case-management');
            container.innerHTML = '';

            if (config.useCases.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìã</div><div class="empty-state-text">No use cases yet</div><p>Click "+ Add Use Case" to get started.</p></div>';
                return;
            }

            config.useCases.forEach(useCase => {
                const mappings = config.mappings.filter(m => m.useCaseId === useCase.id);

                const section = document.createElement('div');
                section.className = 'use-case-section';

                let questionsHTML = '';
                if (mappings.length === 0) {
                    questionsHTML = `
                        <div class="add-question-prompt">
                            <p>No questions assigned yet.</p>
                            <button class="btn btn-outline" onclick="showAddQuestionToUseCase(${useCase.id})">+ Add Question</button>
                        </div>
                    `;
                } else {
                    questionsHTML = '<div class="nested-questions">';
                    mappings.forEach(mapping => {
                        const question = config.questions.find(q => q.id === mapping.questionId);
                        if (question) {
                            questionsHTML += `
                                <div class="nested-question-item">
                                    <div class="nested-question-content">
                                        <div class="nested-question-text">${question.text}</div>
                                        <div class="nested-question-meta">Variable: <strong>${mapping.variableName}</strong> | Type: ${question.inputType} | Default: ${question.defaultValue}</div>
                                    </div>
                                    <div class="nested-question-actions">
                                        <button class="btn btn-outline" onclick="editQuestionMapping(${useCase.id}, ${mapping.questionId})">Edit</button>
                                        <button class="btn btn-danger" onclick="deleteMapping(${useCase.id}, ${mapping.questionId})">Remove</button>
                                    </div>
                                </div>
                            `;
                        }
                    });
                    questionsHTML += `<button class="btn btn-outline" onclick="showAddQuestionToUseCase(${useCase.id})" style="margin-top: 10px;">+ Add Another Question</button></div>`;
                }

                section.innerHTML = `
                    <div class="use-case-section-header">
                        <div class="use-case-section-info">
                            <div class="use-case-section-title">${useCase.name}</div>
                            <div class="use-case-section-meta">Category: ${useCase.category}</div>
                            <div class="use-case-formula">Formula: ${useCase.formula}</div>
                        </div>
                        <div class="use-case-section-actions">
                            <button class="btn btn-outline" onclick="editUseCase(${useCase.id})">Edit</button>
                            <button class="btn btn-danger" onclick="deleteUseCase(${useCase.id})">Delete</button>
                        </div>
                    </div>
                    ${questionsHTML}
                `;

                container.appendChild(section);
            });
        }

        function renderQuestionLibrary() {
            const container = document.getElementById('question-library');
            container.innerHTML = '';

            if (config.questions.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ùì</div><div class="empty-state-text">No questions yet</div></div>';
                return;
            }

            config.questions.forEach(question => {
                const usageCount = config.mappings.filter(m => m.questionId === question.id).length;
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <div class="list-item-content">
                        <div class="list-item-title">${question.text}</div>
                        <div class="list-item-meta">Type: ${question.inputType} | Default: ${question.defaultValue} | Used in ${usageCount} use case${usageCount !== 1 ? 's' : ''}</div>
                    </div>
                    <div class="list-item-actions">
                        <button class="btn btn-outline" onclick="editQuestion(${question.id})">Edit</button>
                        <button class="btn btn-danger" onclick="deleteQuestion(${question.id})">Delete</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Modal Functions
        function showAddUseCaseForm() {
            document.getElementById('modal-body').innerHTML = `
                <h2 class="modal-title">Add Use Case</h2>
                <form onsubmit="saveUseCase(event)">
                    <div class="form-group">
                        <label>Use Case Name</label>
                        <input type="text" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <input type="text" name="category" placeholder="e.g., Joiner/Mover/Leaver" required>
                    </div>
                    <div class="form-group">
                        <label>Formula</label>
                        <input type="text" name="formula" placeholder="e.g., numUsers * staffCount * laborRate * hours" required>
                        <small>Use variable names that you'll assign to questions</small>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">Save Use Case</button>
                        <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            `;
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function saveUseCase(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const newId = config.useCases.length > 0 ? Math.max(...config.useCases.map(uc => uc.id)) + 1 : 1;

            config.useCases.push({
                id: newId,
                name: formData.get('name'),
                category: formData.get('category'),
                formula: formData.get('formula')
            });

            saveConfigToStorage();
            closeModal();
            renderConfigPanel();
        }

        function editUseCase(id) {
            const useCase = config.useCases.find(uc => uc.id === id);
            document.getElementById('modal-body').innerHTML = `
                <h2 class="modal-title">Edit Use Case</h2>
                <form onsubmit="updateUseCase(event, ${id})">
                    <div class="form-group">
                        <label>Use Case Name</label>
                        <input type="text" name="name" value="${useCase.name}" required>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <input type="text" name="category" value="${useCase.category}" required>
                    </div>
                    <div class="form-group">
                        <label>Formula</label>
                        <input type="text" name="formula" value="${useCase.formula}" required>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">Update</button>
                        <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            `;
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function updateUseCase(event, id) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const useCase = config.useCases.find(uc => uc.id === id);
            
            useCase.name = formData.get('name');
            useCase.category = formData.get('category');
            useCase.formula = formData.get('formula');

            saveConfigToStorage();
            closeModal();
            renderConfigPanel();
        }

        function deleteUseCase(id) {
            if (!confirm('Delete this use case and all its question mappings?')) return;
            config.useCases = config.useCases.filter(uc => uc.id !== id);
            config.mappings = config.mappings.filter(m => m.useCaseId !== id);
            saveConfigToStorage();
            renderConfigPanel();
        }

        function showAddQuestionForm() {
            document.getElementById('modal-body').innerHTML = `
                <h2 class="modal-title">Add Question</h2>
                <form onsubmit="saveQuestion(event)">
                    <div class="form-group">
                        <label>Question Text</label>
                        <textarea name="text" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Input Type</label>
                        <select name="inputType" required>
                            <option value="number">Number</option>
                            <option value="text">Text</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Default Value</label>
                        <input type="number" name="defaultValue" value="0" required>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">Save Question</button>
                        <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            `;
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function saveQuestion(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const newId = config.questions.length > 0 ? Math.max(...config.questions.map(q => q.id)) + 1 : 1;

            config.questions.push({
                id: newId,
                text: formData.get('text'),
                inputType: formData.get('inputType'),
                defaultValue: parseFloat(formData.get('defaultValue')) || 0
            });

            saveConfigToStorage();
            closeModal();
            renderConfigPanel();
        }

        function editQuestion(id) {
            const question = config.questions.find(q => q.id === id);
            document.getElementById('modal-body').innerHTML = `
                <h2 class="modal-title">Edit Question</h2>
                <form onsubmit="updateQuestion(event, ${id})">
                    <div class="form-group">
                        <label>Question Text</label>
                        <textarea name="text" required>${question.text}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Input Type</label>
                        <select name="inputType" required>
                            <option value="number" ${question.inputType === 'number' ? 'selected' : ''}>Number</option>
                            <option value="text" ${question.inputType === 'text' ? 'selected' : ''}>Text</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Default Value</label>
                        <input type="number" name="defaultValue" value="${question.defaultValue}" required>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">Update</button>
                        <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            `;
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function updateQuestion(event, id) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const question = config.questions.find(q => q.id === id);

            question.text = formData.get('text');
            question.inputType = formData.get('inputType');
            question.defaultValue = parseFloat(formData.get('defaultValue')) || 0;

            saveConfigToStorage();
            closeModal();
            renderConfigPanel();
        }

        function deleteQuestion(id) {
            if (!confirm('Delete this question? It will be removed from all use cases.')) return;
            config.questions = config.questions.filter(q => q.id !== id);
            config.mappings = config.mappings.filter(m => m.questionId !== id);
            saveConfigToStorage();
            renderConfigPanel();
        }

        function showAddQuestionToUseCase(useCaseId) {
            const useCase = config.useCases.find(uc => uc.id === useCaseId);
            const availableQuestions = config.questions.filter(q =>
                !config.mappings.some(m => m.useCaseId === useCaseId && m.questionId === q.id)
            );

            if (availableQuestions.length === 0) {
                alert('All questions are already mapped. Create a new question first.');
                return;
            }

            document.getElementById('modal-body').innerHTML = `
                <h2 class="modal-title">Add Question to "${useCase.name}"</h2>
                <form onsubmit="saveMappingToUseCase(event, ${useCaseId})">
                    <div class="form-group">
                        <label>Select Question</label>
                        <select name="questionId" required>
                            <option value="">Choose a question...</option>
                            ${availableQuestions.map(q => `<option value="${q.id}">${q.text}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Variable Name</label>
                        <input type="text" name="variableName" placeholder="e.g., numUsers, staffCount" required>
                        <small>Formula: ${useCase.formula}</small>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">Add Question</button>
                        <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            `;
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function saveMappingToUseCase(event, useCaseId) {
            event.preventDefault();
            const formData = new FormData(event.target);

            config.mappings.push({
                useCaseId: useCaseId,
                questionId: parseInt(formData.get('questionId')),
                variableName: formData.get('variableName')
            });

            saveConfigToStorage();
            closeModal();
            renderConfigPanel();
        }

        function editQuestionMapping(useCaseId, questionId) {
            const mapping = config.mappings.find(m => m.useCaseId === useCaseId && m.questionId === questionId);
            const question = config.questions.find(q => q.id === questionId);
            const useCase = config.useCases.find(uc => uc.id === useCaseId);

            document.getElementById('modal-body').innerHTML = `
                <h2 class="modal-title">Edit Question Mapping</h2>
                <form onsubmit="updateQuestionMapping(event, ${useCaseId}, ${questionId})">
                    <div class="form-group">
                        <label>Question</label>
                        <div style="padding: 12px; background: #f5f5f5; border-radius: 8px;">${question.text}</div>
                    </div>
                    <div class="form-group">
                        <label>Variable Name</label>
                        <input type="text" name="variableName" value="${mapping.variableName}" required>
                        <small>Formula: ${useCase.formula}</small>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">Update</button>
                        <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            `;
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function updateQuestionMapping(event, useCaseId, questionId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const mapping = config.mappings.find(m => m.useCaseId === useCaseId && m.questionId === questionId);
            mapping.variableName = formData.get('variableName');

            saveConfigToStorage();
            closeModal();
            renderConfigPanel();
        }

        function deleteMapping(useCaseId, questionId) {
            if (!confirm('Remove this question from the use case?')) return;
            config.mappings = config.mappings.filter(m => !(m.useCaseId === useCaseId && m.questionId === questionId));
            saveConfigToStorage();
            renderConfigPanel();
        }

        function exportConfiguration() {
            const dataStr = JSON.stringify(config, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'idmworks-tco-config.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        function importConfiguration(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    config = JSON.parse(e.target.result);
                    saveConfigToStorage();
                    renderConfigPanel();
                    alert('Configuration imported successfully!');
                } catch (error) {
                    alert('Error importing: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function closeModal(event) {
            if (!event || event.target.classList.contains('modal-overlay')) {
                document.getElementById('modal-overlay').style.display = 'none';
            }
        }

        // Initialize
        init();
    </script>
</body>
</html>